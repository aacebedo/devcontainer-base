[lint]
description = "Run pre-commit hooks on all files"
run = """
#!/usr/bin/env sh
set -eu
pre-commit run --all-files
"""

[build]
description = "Build the container image"
run = """
#!/usr/bin/env sh
set -eu
podman build -t "{{vars.docker_tag}}" \\
  --label "org.opencontainers.image.source={{vars.repo_url}}" \\
  --label "org.opencontainers.image.description=Development container base" \\
  --label "org.opencontainers.image.licenses=MIT" \\
  --label "org.opencontainers.image.title={{vars.repo_name}}" \\
  --label "org.opencontainers.image.vendor={{vars.repo_owner}}" .
"""

[test]
description = "Build and run the container image"
depends = ["build"]
run = """
#!/usr/bin/env sh
set -eu
podman run --rm '{{vars.docker_tag}}'
"""

[security-scan]
description = "Run Trivy security scan on the built image"
depends = ["build"]
run = """
#!/usr/bin/env sh
set -eu
TEMP_DIR=$(mktemp -d)
podman save {{vars.docker_tag}} | gzip > "$TEMP_DIR/image.tar.gz"
trivy image --input "$TEMP_DIR/image.tar.gz" --format sarif \\
  --skip-version-check --output /tmp/trivy-results.sarif
rm -rf "$TEMP_DIR"
"""

[release]
description = "Lint, test, security-scan, then publish a release"
depends = ["lint", "test", "security-scan"]
run = """
#!/usr/bin/env sh
set -eu
sudo ln -sf /usr/bin/podman /usr/local/bin/docker
semantic-release
"""

[clean]
description = "Remove generated Vale configuration files"
run = """
#!/usr/bin/env sh
set -eu
rm -rf .vale/.vale-config .vale/Google
"""
